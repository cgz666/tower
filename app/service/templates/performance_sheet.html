<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>0104项目22站性能数据表</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --card: #ffffff;
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --radius: 12px;
      --shadow: 0 8px 20px rgba(0,0,0,.08);
      --transition: .25s ease-in-out;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"思源黑体","Helvetica Neue",Arial,sans-serif;background:var(--bg);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
    .wrapper{width:100%;max-width:520px}
    h3{text-align:center;margin:0 0 2rem;font-size:1.5rem;color:#1f2937}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:2rem 2.5rem}
    .link-row{display:block;margin:.75rem 0;padding:.9rem 1.2rem;border-radius:8px;text-decoration:none;color:var(--primary);background:#f3f4f6;transition:var(--transition);font-weight:500;position:relative;overflow:hidden}
    .link-row:hover{background:var(--primary);color:#fff;transform:translateY(-2px);box-shadow:0 4px 12px rgba(79,70,229,.35)}
    .link-row::before{content:"";position:absolute;left:0;top:0;height:100%;width:4px;background:var(--primary-light);transform:scaleY(0);transition:var(--transition)}
    .link-row:hover::before{transform:scaleY(1)}
    .update-box{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem}
    .update-btn{background:var(--primary);color:#fff;border:none;padding:.6rem 1.2rem;border-radius:6px;cursor:pointer;font-size:1rem;transition:var(--transition)}
    .update-btn:hover:not(:disabled){background:var(--primary-light)}
    .update-btn:disabled{background:#ccc;cursor:not-allowed}
    .time-stamp{font-size:.85rem;color:#555}
    .countdown{font-size:.85rem;color:#666;margin-left:10px}
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="card">
      <h3>0104项目22站性能数据表</h3>

    <div class="update-box" style="display:flex;justify-content:center;align-items:center;">
      <button id="updateBtn" class="update-btn">更新数据</button>
      <span id="countdown" class="countdown"></span>
    </div>

    {% for h in hours %}
      <a class="link-row" href="{{ url_for('download', hour=h) }}">
        <span>{{ h }} 点通报表</span>
        <span class="time-stamp">最新更新时间：<span id="time-{{ h }}">{{ times[h] }}</span></span>
      </a>
    {% endfor %}
    </div>
  </div>

  <script>
    const btn = document.getElementById('updateBtn');
    const countdownEl = document.getElementById('countdown');
    const globalTime = document.getElementById('globalTime');

    // 检查是否处于冷却期
    function checkCooldown() {
      const lastUpdateTime = localStorage.getItem('lastUpdateTime');
      if (lastUpdateTime) {
        const now = Date.now();
        const cooldownEnd = parseInt(lastUpdateTime) + 5 * 60 * 1000; // 5分钟

        if (now < cooldownEnd) {
          const remainingTime = cooldownEnd - now;
          disableButton(remainingTime);
          return true;
        }
      }
      return false;
    }

    // 禁用按钮并显示倒计时
    function disableButton(remainingTime) {
      btn.disabled = true;
      updateCountdown(remainingTime);

      const interval = setInterval(() => {
        const newRemainingTime = remainingTime - 1000;
        if (newRemainingTime <= 0) {
          enableButton();
          clearInterval(interval);
        } else {
          updateCountdown(newRemainingTime);
          remainingTime = newRemainingTime;
        }
      }, 1000);
    }

    // 启用按钮
    function enableButton() {
      btn.disabled = false;
      btn.textContent = '更新数据';
      countdownEl.textContent = '';
      localStorage.removeItem('lastUpdateTime');
    }

    // 更新倒计时显示
    function updateCountdown(remainingTime) {
      const minutes = Math.floor(remainingTime / 60000);
      const seconds = Math.floor((remainingTime % 60000) / 1000);
      countdownEl.textContent = `(${minutes}:${seconds.toString().padStart(2, '0')})`;
      btn.textContent = '更新中...';
    }

    // 页面加载时检查冷却状态
    checkCooldown();

    btn.onclick = async () => {
      // 再次检查冷却期（防止localStorage被手动清除）
      if (checkCooldown()) {
        return;
      }

      btn.disabled = true;
      btn.textContent = '更新中...';

      try {
        const res = await fetch('{{ url_for("update_and_info") }}', {method:'POST'});
        const json = await res.json();
        if(json.status==='success'){
          // 记录更新时间
          localStorage.setItem('lastUpdateTime', Date.now().toString());

          // 刷新每个时间戳
          for(const [h,t] of Object.entries(json.times)){
            document.getElementById(`time-${h}`).textContent = t;
          }
          globalTime.textContent = '（已更新）';

          // 启动5分钟冷却期
          disableButton(5 * 60 * 1000);
        }
      } catch(e) {
        globalTime.textContent = '更新失败';
        // 出错时也启动冷却期，防止频繁重试
        localStorage.setItem('lastUpdateTime', Date.now().toString());
        disableButton(5 * 60 * 1000);
      }
    };
  </script>
</body>
</html>